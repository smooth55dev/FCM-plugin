<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Example App</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .status h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .status p {
            margin: 5px 0;
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
        }
        
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1976d2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success {
            background: #4caf50;
        }
        
        .success:hover {
            background: #45a049;
        }
        
        .warning {
            background: #ff9800;
        }
        
        .warning:hover {
            background: #f57c00;
        }
        
        .danger {
            background: #f44336;
        }
        
        .danger:hover {
            background: #da190b;
        }
        
        .fcm-notification {
            background: #4caf50;
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(-100%); 
                opacity: 0;
            }
            to { 
                transform: translateX(0); 
                opacity: 1;
            }
        }
        
        .messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .message {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 3px solid #2196f3;
        }
        
        .message h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .message p {
            margin: 0 0 5px 0;
            color: #666;
        }
        
        .message small {
            color: #999;
            font-size: 12px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-info { color: #569cd6; }
        .log-success { color: #4ec9b0; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f44747; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• FCM Example App</h1>
        
        <div class="status">
            <h3>üì± Status</h3>
            <p id="status">Initializing FCM...</p>
            <p id="token">Token: <span class="loading"></span></p>
            <p id="permissions">Permissions: Checking...</p>
            <p id="context">Context: <span id="context-info">Detecting...</span></p>
        </div>
        
        <div class="section">
            <h3>üéØ Topic Management</h3>
            <button onclick="subscribeToNews()" id="news-sub">Subscribe to News</button>
            <button onclick="unsubscribeFromNews()" id="news-unsub" class="warning">Unsubscribe from News</button>
            <br>
            <button onclick="subscribeToWeather()" id="weather-sub">Subscribe to Weather</button>
            <button onclick="unsubscribeFromWeather()" id="weather-unsub" class="warning">Unsubscribe from Weather</button>
        </div>
        
        <div class="section">
            <h3>‚öôÔ∏è Actions</h3>
            <button onclick="checkNotificationStatus()">Check Notification Status</button>
            <button onclick="getLastMessage()">Get Last Message</button>
            <button onclick="deleteToken()" class="danger">Delete Token</button>
            <button onclick="clearMessages()" class="warning">Clear Messages</button>
        </div>
        
        <div class="section">
            <h3>üì® Messages</h3>
            <div id="messages" class="messages">
                <p style="text-align: center; color: #999; margin: 20px 0;">No messages received yet</p>
            </div>
        </div>
        
        <div class="section">
            <h3>üìã Console Log</h3>
            <button onclick="clearLog()" class="warning">Clear Log</button>
            <div id="console-log" class="log">
                <div class="log-entry log-info">[INFO] FCM Example App initialized</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Check if running in Tauri context
        let createFcm;
        if (typeof window.__TAURI__ !== 'undefined') {
            // Running in Tauri - import the real FCM module
            try {
                const fcmModule = await import('./js/index.js');
                createFcm = fcmModule.createFcm;
            } catch (error) {
                console.error('Failed to import FCM module:', error);
                createFcm = null;
            }
        } else {
            // Running in browser - create mock functions
            createFcm = () => ({
                getToken: () => Promise.reject(new Error('FCM not available in browser')),
                subscribeToTopic: () => Promise.reject(new Error('FCM not available in browser')),
                unsubscribeFromTopic: () => Promise.reject(new Error('FCM not available in browser')),
                areNotificationsEnabled: () => Promise.reject(new Error('FCM not available in browser')),
                requestNotificationPermission: () => Promise.reject(new Error('FCM not available in browser')),
                deleteToken: () => Promise.reject(new Error('FCM not available in browser')),
                getLastMessage: () => Promise.reject(new Error('FCM not available in browser')),
                onTokenReceived: () => Promise.resolve({ unlisten: () => {} }),
                onTokenRefresh: () => Promise.resolve({ unlisten: () => {} }),
                onMessageReceived: () => Promise.resolve({ unlisten: () => {} }),
                onTopicChanged: () => Promise.resolve({ unlisten: () => {} }),
                onTokenError: () => Promise.resolve({ unlisten: () => {} }),
            });
        }

        class FcmManager {
            constructor() {
                this.isTauriContext = typeof window.__TAURI__ !== 'undefined';
                this.fcm = createFcm ? createFcm() : null;
                this.setupEventListeners();
                this.updateContextInfo();
                this.log('FCM Manager created', 'info');
            }

            updateContextInfo() {
                const contextInfo = document.getElementById('context-info');
                if (this.isTauriContext) {
                    contextInfo.textContent = 'Tauri App';
                    contextInfo.style.color = '#4caf50';
                } else {
                    contextInfo.textContent = 'Browser (Mock Mode)';
                    contextInfo.style.color = '#ff9800';
                }
            }

            async initialize() {
                try {
                    if (!this.isTauriContext) {
                        this.log('Running in browser mode - FCM functions not available', 'warning');
                        this.updateStatus('Browser mode - FCM not available');
                        this.updatePermissions('N/A (Browser)');
                        this.updateToken('N/A (Browser)');
                        return null;
                    }

                    this.log('Initializing FCM...', 'info');
                    this.updateStatus('Requesting permissions...');
                    
                    // Request notification permission
                    const granted = await this.fcm.requestNotificationPermission();
                    this.log(`Permission granted: ${granted}`, granted ? 'success' : 'warning');
                    this.updatePermissions(granted ? 'Granted' : 'Denied');

                    // Get FCM token
                    this.updateStatus('Getting FCM token...');
                    const token = await this.fcm.getToken();
                    this.log(`FCM Token received: ${token.substring(0, 20)}...`, 'success');
                    this.updateToken(token);
                    this.updateStatus('FCM initialized successfully');

                    return token;
                } catch (error) {
                    this.log(`FCM initialization error: ${error.message}`, 'error');
                    this.updateStatus(`Error: ${error.message}`);
                    throw error;
                }
            }

            setupEventListeners() {
                if (!this.fcm) {
                    this.log('FCM not available - event listeners not set up', 'warning');
                    return;
                }

                // Listen for token received
                this.fcm.onTokenReceived((event) => {
                    this.log(`Token received: ${event.token.substring(0, 20)}...`, 'success');
                    this.updateToken(event.token);
                });

                // Listen for token refresh
                this.fcm.onTokenRefresh((event) => {
                    this.log(`Token refreshed: ${event.token.substring(0, 20)}...`, 'info');
                    this.updateToken(event.token);
                });

                // Listen for messages
                this.fcm.onMessageReceived((message) => {
                    this.log(`Message received: ${message.notification?.title || 'No title'}`, 'info');
                    this.handleMessage(message);
                });

                // Listen for topic changes
                this.fcm.onTopicChanged((event) => {
                    this.log(`Topic ${event.topic} ${event.action}`, 'info');
                    this.updateTopicButtons();
                });

                // Listen for errors
                this.fcm.onTokenError((event) => {
                    this.log(`FCM Error: ${event.error}`, 'error');
                });
            }

            handleMessage(message) {
                this.addMessage(message);
            }

            addMessage(message) {
                const messagesDiv = document.getElementById('messages');
                
                // Remove "no messages" placeholder
                const placeholder = messagesDiv.querySelector('p');
                if (placeholder) {
                    placeholder.remove();
                }

                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <h4>${message.notification?.title || 'Message'}</h4>
                    <p>${message.notification?.body || JSON.stringify(message.data || {})}</p>
                    <small>${new Date().toLocaleTimeString()}</small>
                `;
                
                messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }

            updateToken(token) {
                document.getElementById('token').innerHTML = `Token: <span style="color: #4caf50;">${token.substring(0, 20)}...</span>`;
            }

            updatePermissions(status) {
                document.getElementById('permissions').innerHTML = `Permissions: <span style="color: ${status === 'Granted' ? '#4caf50' : '#f44336'};">${status}</span>`;
            }

            log(message, type = 'info') {
                const logDiv = document.getElementById('console-log');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            async subscribeToTopic(topic) {
                if (!this.isTauriContext) {
                    this.log(`Mock: Would subscribe to topic: ${topic}`, 'info');
                    return;
                }
                try {
                    await this.fcm.subscribeToTopic(topic);
                    this.log(`Subscribed to topic: ${topic}`, 'success');
                } catch (error) {
                    this.log(`Failed to subscribe to topic ${topic}: ${error.message}`, 'error');
                }
            }

            async unsubscribeFromTopic(topic) {
                if (!this.isTauriContext) {
                    this.log(`Mock: Would unsubscribe from topic: ${topic}`, 'info');
                    return;
                }
                try {
                    await this.fcm.unsubscribeFromTopic(topic);
                    this.log(`Unsubscribed from topic: ${topic}`, 'success');
                } catch (error) {
                    this.log(`Failed to unsubscribe from topic ${topic}: ${error.message}`, 'error');
                }
            }

            async checkNotificationStatus() {
                if (!this.isTauriContext) {
                    this.log('Mock: Would check notification status', 'info');
                    return;
                }
                try {
                    const enabled = await this.fcm.areNotificationsEnabled();
                    this.log(`Notifications ${enabled ? 'enabled' : 'disabled'}`, enabled ? 'success' : 'warning');
                    this.updatePermissions(enabled ? 'Enabled' : 'Disabled');
                } catch (error) {
                    this.log(`Failed to check notification status: ${error.message}`, 'error');
                }
            }

            async getLastMessage() {
                if (!this.isTauriContext) {
                    this.log('Mock: Would get last message', 'info');
                    return;
                }
                try {
                    const message = await this.fcm.getLastMessage();
                    if (message) {
                        this.log('Retrieved last message', 'info');
                        this.addMessage(message);
                    } else {
                        this.log('No last message available', 'warning');
                    }
                } catch (error) {
                    this.log(`Failed to get last message: ${error.message}`, 'error');
                }
            }

            async deleteToken() {
                if (!this.isTauriContext) {
                    this.log('Mock: Would delete token', 'info');
                    return;
                }
                try {
                    await this.fcm.deleteToken();
                    this.log('FCM token deleted', 'warning');
                    this.updateToken('Deleted');
                    this.updateStatus('Token deleted');
                } catch (error) {
                    this.log(`Failed to delete token: ${error.message}`, 'error');
                }
            }
        }

        // Global functions for UI
        let fcmManager;

        // Initialize FCM when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            fcmManager = new FcmManager();
            
            try {
                const token = await fcmManager.initialize();
                console.log('FCM initialized successfully with token:', token);
                
                // Make fcmManager available globally for testing
                window.fcmManager = fcmManager;
            } catch (error) {
                console.error('Failed to initialize FCM:', error);
            }
        });

        // Topic management functions
        async function subscribeToNews() {
            if (fcmManager) {
                await fcmManager.subscribeToTopic('news');
            }
        }

        async function unsubscribeFromNews() {
            if (fcmManager) {
                await fcmManager.unsubscribeFromTopic('news');
            }
        }

        async function subscribeToWeather() {
            if (fcmManager) {
                await fcmManager.subscribeToTopic('weather');
            }
        }

        async function unsubscribeFromWeather() {
            if (fcmManager) {
                await fcmManager.unsubscribeFromTopic('weather');
            }
        }

        // Action functions
        async function checkNotificationStatus() {
            if (fcmManager) {
                await fcmManager.checkNotificationStatus();
            }
        }

        async function getLastMessage() {
            if (fcmManager) {
                await fcmManager.getLastMessage();
            }
        }

        async function deleteToken() {
            if (fcmManager) {
                if (confirm('Are you sure you want to delete the FCM token?')) {
                    await fcmManager.deleteToken();
                }
            }
        }

        function clearMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">No messages received yet</p>';
        }

        function clearLog() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = '<div class="log-entry log-info">[INFO] Log cleared</div>';
        }

        // Make functions available globally
        window.subscribeToNews = subscribeToNews;
        window.unsubscribeFromNews = unsubscribeFromNews;
        window.subscribeToWeather = subscribeToWeather;
        window.unsubscribeFromWeather = unsubscribeFromWeather;
        window.checkNotificationStatus = checkNotificationStatus;
        window.getLastMessage = getLastMessage;
        window.deleteToken = deleteToken;
        window.clearMessages = clearMessages;
        window.clearLog = clearLog;
    </script>
</body>
</html>